# version: '3.8'

services:
  zookeeper:
    image: bitnami/zookeeper:3.8
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    networks:
      - market-net

  kafka:
    image: bitnami/kafka:3.4
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_LISTENERS=PLAINTEXT://0.0.0.0:9092
      - KAFKA_BROKER_ID=1
      - ALLOW_PLAINTEXT_LISTENER=yes
    depends_on:
      - zookeeper
    networks:
      - market-net

  influxdb:
    image: influxdb:2.7
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=root
      - DOCKER_INFLUXDB_INIT_PASSWORD=rootroot
      - DOCKER_INFLUXDB_INIT_ORG=BreOrganization
      - DOCKER_INFLUXDB_INIT_BUCKET=prices
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN='J4twWiQSH6QZF33ZyAB9NJLoNMyrHjOlvY6UJGgczJfk-_DC3d5BFEiZzQOYC39ObPYwxF5kZTAZtzIX-Xr40Q=='
    volumes:
      - influxdb-data:/var/lib/influxdb2
    networks:
      - market-net

  producer:
    build: .
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=prices
      - EXCHANGES=binance,kucoin,bybit,coinbase,kraken
      - SYMBOLS=BTC/USDT,XMR/USDT,ETH/USDT
      - FETCH_INTERVAL=10
    depends_on:
      - kafka
    networks:
      - market-net
    command: ["python", "producer.py"]

  consumer:
    build: .
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=prices
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=J4twWiQSH6QZF33ZyAB9NJLoNMyrHjOlvY6UJGgczJfk-_DC3d5BFEiZzQOYC39ObPYwxF5kZTAZtzIX-Xr40Q==
      - INFLUXDB_ORG=BreOrganization
      - INFLUXDB_BUCKET=prices
    depends_on:
      - kafka
      - influxdb
    networks:
      - market-net
    command: ["python", "consumer.py"]

  evolves:
    build: ./evolves   # o image: si ya tienes una imagen
    container_name: evolves
    depends_on:
      - influxdb
      - kafka
      - zookeeper
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=J4twWiQSH6QZF33ZyAB9NJLoNMyrHjOlvY6UJGgczJfk-_DC3d5BFEiZzQOYC39ObPYwxF5kZTAZtzIX-Xr40Q==
      - INFLUXDB_ORG=BreOrganization
      - INFLUXDB_BUCKET=prices
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=prices
    command: ["python", "evolves3.py  --symbol BTCUSDT --exchange binance --timeframe 1m --start -7d --limit 1000"]

networks:
  market-net:

volumes:
  influxdb-data:
